# Futevolei Game Management - Terraform & AWS Setup

This project provides infrastructure and backend setup to manage **Futevôlei games** using AWS services (Lambda, API Gateway, S3, DynamoDB) and Terraform.

---

## Prerequisites

Before you start, make sure you have the following installed and configured:

- **AWS CLI**  
  Install: [AWS CLI Installation](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html)  
  Configure with credentials:
  ```bash
  aws configure
  ```

Make sure your IAM user has permissions to create:

- Lambda functions

- API Gateway

- S3 buckets

- DynamoDB tables

- IAM roles and policies

- CloudWatch logs

- **Terraform**
  Version >= 1.5 recommended.
  Install: [Terraform Installation](https://learn.hashicorp.com/tutorials/terraform/install-cli)

- **Node.js & npm**
  Required to build Lambda functions.
  Install: [Node.js](https://nodejs.org/)

- **Make**
  Required to run the provided Makefile.

---

## Project Structure

```
.
├── lambdas/          # Lambda functions code (Node.js)
├── frontend/         # Static frontend assets (HTML, JS, CSS)
├── infra/            # Terraform configuration files
├── Makefile          # Commands to build and deploy
└── README.md
```

---

## Step 1: Setup Terraform State

Create the S3 bucket and DynamoDB table for Terraform remote state and locking:

```bash
make setup
```

This will run a script that sets up:

- S3 bucket for Terraform state
- DynamoDB table for Terraform locks

---

## Step 2: Create Terraform Workspaces

Terraform workspaces are used to separate **dev** and **prod** environments. Run:

```bash
cd infra
terraform workspace new dev
terraform workspace new prod
```

You can select a workspace using:

```bash
terraform workspace select dev
```

> Only `dev` and `prod` workspaces are supported. Do not create extra workspaces to avoid additional costs.

---

## Step 3: Package Lambda Functions

Before deploying, package the Lambda functions:

```bash
make lambda
```

This will:

1. Install Node.js dependencies (`aws-sdk` and `uuid`) for each Lambda.
2. Create a zip file for each Lambda function to be deployed by Terraform.

---

## Step 4: Deploy the Infrastructure

Use the Makefile to deploy each environment:

- **Dev Environment:**

```bash
make dev
```

- **Prod Environment:**

```bash
make prod
```

These commands will:

1. Apply Terraform configuration to the selected workspace
2. Create S3 buckets, DynamoDB tables, Lambda functions, API Gateway resources, and permissions

> Always run `make lambda` before deploying to ensure Lambda packages are up-to-date.

---

## Step 5: Frontend Configuration

The frontend `config.js` is dynamically generated by Terraform with the API Gateway URL for the selected workspace. The `main.js` and `styles.css` files are uploaded to S3 as part of the deployment.

No manual configuration is needed for the frontend.

---

## Step 6: Access the Application

- S3 Bucket static website URL:

  ```
  http://<workspace>-futevolei-website.s3-website-us-east-1.amazonaws.com
  ```

- API Gateway URL:

  The API Gateway URL is automatically injected into the frontend `config.js`. You can also find it in Terraform outputs using the following command:

```bash
terraform output api_http_url
```

> Make sure you have selected the correct workspace with `terraform workspace select dev` or `terraform workspace select prod` before checking outputs.

---

## Step 7: Destroying Resources

To destroy resources in a specific environment:

- **Dev Environment:**

```bash
make dev-destroy
```

- **Prod Environment:**

```bash
make prod-destroy
```

> Be careful: this will permanently remove all resources in the selected environment.

---

## References

- [Terraform AWS Provider](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
- [AWS Lambda](https://docs.aws.amazon.com/lambda/latest/dg/welcome.html)
- [AWS API Gateway](https://docs.aws.amazon.com/apigateway/latest/developerguide/welcome.html)
- [AWS S3](https://docs.aws.amazon.com/s3/index.html)
- [AWS DynamoDB](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Introduction.html)
