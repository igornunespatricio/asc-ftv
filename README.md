# Futevolei Game Management - Terraform & AWS Setup

This project provides infrastructure and backend setup to manage **Futevôlei games** using AWS services (Lambda, API Gateway, S3, DynamoDB) and Terraform.

---

## Prerequisites

Before you start, make sure you have the following installed and configured:

- **AWS CLI**  
  Install: [AWS CLI Installation](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html)  
  Configure with credentials:
  ```bash
  aws configure
  ```

Make sure your IAM user has permissions to create:

- Lambda functions

- API Gateway

- S3 buckets

- DynamoDB tables

- IAM roles and policies

- CloudWatch logs

- **Terraform**
  Version >= 1.5 recommended.
  Install: [Terraform Installation](https://learn.hashicorp.com/tutorials/terraform/install-cli)

- **Node.js & npm**
  Required to build Lambda functions and frontend application.
  Install: [Node.js](https://nodejs.org/)

- **Make**
  Required to run the provided Makefile.

---

## Project Structure

```
.
├── frontend/         # Frontend application (TypeScript, HTML, CSS)
├── lambdas/          # Lambda functions code (Node.js)
├── infra/            # Terraform configuration files
├── scripts/          # Shell scripts for setup and utilities
├── test-scripts/     # Test scripts for validation
├── Makefile          # Commands to build and deploy
└── README.md
```

## Directory Overview

- [frontend/](frontend/) - Static web application with HTML, CSS, TypeScript for user interface and game management
- [infra/](infra/) - Terraform infrastructure as code for AWS resources
- [lambdas/](lambdas/) - Serverless functions for backend API
- [scripts/](scripts/) - Automation scripts for development setup
- [test-scripts/](test-scripts/) - Validation tests for application functionality

---

## Step 1: Setup Terraform State

Create the S3 bucket and DynamoDB table for Terraform remote state and locking:

```bash
./scripts/setup_structure.sh
```

This script will create:

- S3 bucket for Terraform state storage
- DynamoDB table for Terraform state locking

---

## Step 2: Create Terraform Workspaces

Terraform workspaces are used to separate **dev** and **prod** environments. Run:

```bash
cd infra
terraform workspace new dev
terraform workspace new prod
```

You can select a workspace using:

```bash
terraform workspace select dev
```

> Only `dev` and `prod` workspaces are supported. Do not create extra workspaces to avoid additional costs.

---

## Step 3: Install Lambda Dependencies

Before deploying, install dependencies for all Lambda functions:

```bash
make lambda-install-all
```

This will:

1. Install Node.js production dependencies for each Lambda function
2. Prepare Lambda packages for deployment by Terraform

---

## Step 4: Deploy the Infrastructure

Use the Makefile to deploy each environment:

- **Dev Environment:**

```bash
make dev
```

- **Prod Environment:**

```bash
make prod
```

These commands will:

1. Apply Terraform configuration to the selected workspace
2. Create S3 buckets, DynamoDB tables, Lambda functions, API Gateway resources, and permissions

> The deployment commands automatically install Lambda dependencies, but you can run `make lambda-install-all` manually if needed.

---

## Step 5: Frontend Build and Deployment

The deployment automatically builds the frontend application:

1. TypeScript sources are compiled to JavaScript using webpack
2. CSS and HTML assets are processed and bundled
3. The `config.js` file is dynamically generated by Terraform with the API Gateway URL
4. Built assets from the `dist/` directory are uploaded to S3

No manual configuration is needed for the frontend.

---

## Step 6: Access the Application

- CloudFront Distribution URL:

  The application is served through CloudFront CDN. Get the distribution URL using:

```bash
terraform output cloudfront_domain
```

- API Gateway URL:

  The API Gateway URL is automatically injected into the frontend `config.js`. You can also find it in Terraform outputs using the following command:

```bash
terraform output api_http_url
```

> Make sure you have selected the correct workspace with `terraform workspace select dev` or `terraform workspace select prod` before checking outputs.

---

## Step 7: Destroying Resources

To destroy resources in a specific environment:

- **Dev Environment:**

```bash
make dev-destroy
```

- **Prod Environment:**

```bash
make prod-destroy
```

> Be careful: this will permanently remove all resources in the selected environment.

---

## Makefile Commands

- `make lambda-install-all` - Install dependencies for all lambda functions in a for-each approach
- `make dev` - Deploy to development environment using Terraform dev workspace
- `make prod` - Deploy to production environment using Terraform prod workspace
- `make check` - Run automated documentation generation and validation checks

---

## References

- [Terraform AWS Provider](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
- [AWS Lambda](https://docs.aws.amazon.com/lambda/latest/dg/welcome.html)
- [AWS API Gateway](https://docs.aws.amazon.com/apigateway/latest/developerguide/welcome.html)
- [AWS S3](https://docs.aws.amazon.com/s3/index.html)
- [AWS DynamoDB](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Introduction.html)
